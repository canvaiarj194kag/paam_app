<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PAAM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 15px; text-align: center; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 400px; margin: 0 auto; }
        .button { display: block; width: 100%; padding: 15px; margin-bottom: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button:active { transform: scale(0.98); box-shadow: none; }
        .questions-block { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; line-height: 1.6; font-size: 15px; }
        #recorder-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .recorder-buttons { display: flex; justify-content: space-around; gap: 10px; }
        .recorder-buttons .button { width: auto; flex-grow: 1; }
        .voice-btn.recording { background-color: #dc3545 !important; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        #audio-player { display: none; background: #e9ecef; padding: 15px; border-radius: 12px; text-align: left; }
        #audio-player .info { font-weight: 600; }
        #audio-player .delete-btn { float: right; color: #dc3545; background: none; border: none; font-size: 20px; cursor: pointer; padding:0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>

    <script>
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        
        const N8N_WEBHOOK_URL = '–í–ê–®_PRODUCTION_URL_–°–Æ–î–ê';
        const appContainer = document.getElementById('app-container');

        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–¢–í–ï–¢–û–í –û–¢ N8N ---
        function handleResponse(response) {
            if (response.type === 'show_reflect_screen') {
                renderReflectScreen(response.title, response.questions);
            } else if (response.type === 'show_text') {
                renderInfoScreen(response.title, response.content);
            } else {
                // –ï—Å–ª–∏ n8n –ø—Ä–∏—Å–ª–∞–ª —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                renderMainMenu();
            }
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –î–ï–ô–°–¢–í–ò–ô –í N8N ---
        async function sendAction(actionName, payload = {}) {
            appContainer.innerHTML = '<h2>–ó–∞–≥—Ä—É–∑–∫–∞...</h2>';
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: actionName,
                        data: {
                            ...payload,
                            user_id: window.Telegram.WebApp.initDataUnsafe.user?.id
                        }
                    })
                });
                const responseData = await response.json();
                handleResponse(responseData);
            } catch (error) {
                console.error("Fetch Error:", error);
                appContainer.innerHTML = '<h2>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏.</h2><button class="button" onclick="renderMainMenu()">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>';
            }
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê –≠–ö–†–ê–ù–û–í ---
        function renderMainMenu() {
            appContainer.innerHTML = `
                <h1>–ú–µ–Ω—é PAAM</h1>
                <button class="button" id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
                <button class="button" id="reflectBtn">üìù Reflect</button>
                <button class="button" id="chatBtn">üí¨ –ß–∞—Ç</button>
                <div class="content-area" id="content-area"><p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.</p></div>
            `;
            document.getElementById('startBtn').addEventListener('click', () => sendAction('start'));
            document.getElementById('reflectBtn').addEventListener('click', () => sendAction('reflect'));
            document.getElementById('chatBtn').addEventListener('click', () => sendAction('chat'));
        }

        function renderReflectScreen(title, questions) {
            appContainer.innerHTML = `
                <h2>${title}</h2>
                <div class="questions-block">${questions.replace(/\\n/g, '<br>')}</div>
                <div id="recorder-container">
                    <div id="audio-player">
                        <button class="delete-btn" id="deleteRecordingBtn">üóëÔ∏è</button>
                        <div class="info">‚úîÔ∏è –ó–∞–ø–∏—Å—å –≥–æ—Ç–æ–≤–∞ (<span id="audio-duration">0:00</span>)</div>
                    </div>
                    <div class="recorder-buttons" id="recorder-controls"></div>
                </div>
                <button class="button" id="sendBtn">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏—é</button>
                <button class="button" onclick="renderMainMenu()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
            `;
            updateRecorderUI('idle');
            document.getElementById('sendBtn').addEventListener('click', sendReflectionData);
        }
        
        function renderInfoScreen(title, content) {
             appContainer.innerHTML = `
                <div class="content-area">
                    <h2>${title}</h2>
                    <p>${content.replace(/\\n/g, '<br>')}</p>
                </div>
                <br>
                <button class="button" onclick="renderMainMenu()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
            `;
        }

        // --- –õ–û–ì–ò–ö–ê –î–ò–ö–¢–û–§–û–ù–ê ---
        function updateRecorderUI(state) {
            const controls = document.getElementById('recorder-controls');
            const player = document.getElementById('audio-player');
            if (!controls || !player) return; // –ó–∞—â–∏—Ç–∞, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã

            switch(state) {
                case 'recording':
                    player.style.display = 'none';
                    controls.innerHTML = `<button class="button recording" id="pauseBtn">‚è∏Ô∏è –ü–∞—É–∑–∞</button><button class="button" id="stopBtn">‚èπÔ∏è –°—Ç–æ–ø</button>`;
                    document.getElementById('pauseBtn').addEventListener('click', pauseRecording);
                    document.getElementById('stopBtn').addEventListener('click', stopRecording);
                    break;
                case 'paused':
                    player.style.display = 'none';
                    controls.innerHTML = `<button class="button" id="resumeBtn">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button><button class="button" id="stopBtn">‚èπÔ∏è –°—Ç–æ–ø</button>`;
                    document.getElementById('resumeBtn').addEventListener('click', resumeRecording);
                    document.getElementById('stopBtn').addEventListener('click', stopRecording);
                    break;
                case 'finished':
                    controls.innerHTML = '';
                    player.style.display = 'block';
                    document.getElementById('deleteRecordingBtn').addEventListener('click', deleteRecording);
                    break;
                case 'idle':
                default:
                    player.style.display = 'none';
                    controls.innerHTML = `<button class="button" id="recordBtn">üé§ –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å</button>`;
                    document.getElementById('recordBtn').addEventListener('click', startRecording);
                    break;
            }
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];
                    audioBlob = null;
                    mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
                    mediaRecorder.addEventListener("stop", () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const duration = (audioChunks.reduce((acc, chunk) => acc + chunk.size, 0) / 15000).toFixed(2).replace('.',':');
                        const durationElem = document.getElementById('audio-duration');
                        if(durationElem) durationElem.textContent = duration;
                        updateRecorderUI('finished');
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    });
                    updateRecorderUI('recording');
                }).catch(err => alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message));
        }

        function pauseRecording() { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.pause(); updateRecorderUI('paused'); } }
        function resumeRecording() { if (mediaRecorder && mediaRecorder.state === "paused") { mediaRecorder.resume(); updateRecorderUI('recording'); } }
        function stopRecording() { if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) { mediaRecorder.stop(); } }
        function deleteRecording() { audioBlob = null; audioChunks = []; updateRecorderUI('idle'); }

        // --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ---
        function sendReflectionData() {
            if (!audioBlob) {
                alert('–í—ã –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏ –≥–æ–ª–æ—Å.');
                return;
            }
            appContainer.innerHTML = '<h2>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...</h2>';
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64Audio = reader.result.split(',')[1];
                sendAction('process_reflection', { audio: base64Audio });
                alert('–í–∞—à–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É! –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–¥–µ—Ç –≤ —á–∞—Ç.');
                renderMainMenu();
            };
            reader.readAsDataURL(audioBlob);
        }

        // --- –ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö ---
        renderMainMenu();
    </script>
</body>
</html>
