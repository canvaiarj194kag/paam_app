<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PAAM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 15px; text-align: center; background-color: #f0f2f5; color: #1c1e21; margin: 0; }
        .container { max-width: 400px; margin: 0 auto; }
        .button { display: block; width: 100%; padding: 15px; margin-bottom: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button:active { transform: scale(0.98); box-shadow: none; }
        .questions-block { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; line-height: 1.6; font-size: 15px; }
        #recorder-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .content-area { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; text-align: left; min-height: 100px;}
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω –±—É–¥–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
    </div>

    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const N8N_WEBHOOK_URL = 'https://primary-production-7ec55.up.railway.app/webhook/e93f8f64-1041-403c-821b-98e0d2627c51'; // <--- –ù–ï –ó–ê–ë–£–î–¨–¢–ï –í–°–¢–ê–í–ò–¢–¨ –í–ê–® URL!
        const appContainer = document.getElementById('app-container');
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;

        // --- –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ n8n ---
        async function sendAction(actionName, payload = {}) {
            renderLoading();
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: actionName,
                        data: {
                            ...payload,
                            user_id: window.Telegram.WebApp.initDataUnsafe.user?.id
                        }
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                handleResponse(responseData);
            } catch (error) {
                console.error("Fetch Error:", error);
                renderError();
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç n8n ---
        function handleResponse(response) {
            if (response && response.type) {
                switch (response.type) {
                    case 'show_reflect_screen':
                        renderReflectScreen(response.title, response.questions);
                        break;
                    case 'show_text':
                        renderInfoScreen(response.title, response.content);
                        break;
                    case 'show_success_screen':
                        renderSuccessScreen(response.message);
                        break;
                    default:
                        renderMainMenu();
                }
            } else {
                renderMainMenu(); // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞) —ç–∫—Ä–∞–Ω–æ–≤ ---
        function renderLoading() {
            appContainer.innerHTML = '<h2>–ó–∞–≥—Ä—É–∑–∫–∞...</h2>';
        }

        function renderError() {
            appContainer.innerHTML = '<h2>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏.</h2><button class="button" onclick="renderMainMenu()">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>';
            document.querySelector('.button').addEventListener('click', renderMainMenu);
        }

        function renderMainMenu() {
            appContainer.innerHTML = `
                <h1>–ú–µ–Ω—é PAAM</h1>
                <button class="button" id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
                <button class="button" id="reflectBtn">üìù Reflect</button>
                <button class="button" id="chatBtn">üí¨ –ß–∞—Ç</button>
                <div class="content-area" id="content-area"><p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.</p></div>
            `;
            document.getElementById('startBtn').addEventListener('click', () => sendAction('start'));
            document.getElementById('reflectBtn').addEventListener('click', () => sendAction('reflect'));
            document.getElementById('chatBtn').addEventListener('click', () => sendAction('chat'));
        }
        
        function renderReflectScreen(title, questions) {
            appContainer.innerHTML = `
                <h2>${title}</h2>
                <div class="questions-block">${questions.replace(/\\n/g, '<br>')}</div>
                <div id="recorder-container"></div>
                <button class="button" id="sendBtn">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏—é</button>
                <button class="button" id="backBtn">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
            `;
            updateRecorderUI('idle'); // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∫—Ç–æ—Ñ–æ–Ω–∞
            document.getElementById('sendBtn').addEventListener('click', sendReflectionData);
            document.getElementById('backBtn').addEventListener('click', renderMainMenu);
        }
        
        function renderSuccessScreen(message) {
            appContainer.innerHTML = `
                <div class="content-area">
                    <h2>‚úÖ –£—Å–ø–µ—Ö!</h2>
                    <p>${message}</p>
                </div>
                <br>
                <button class="button" id="okBtn">–û—Ç–ª–∏—á–Ω–æ!</button>
            `;
            document.getElementById('okBtn').addEventListener('click', renderMainMenu);
        }

        // --- –õ–æ–≥–∏–∫–∞ –¥–∏–∫—Ç–æ—Ñ–æ–Ω–∞ ---
        function updateRecorderUI(state) {
            const recorderContainer = document.getElementById('recorder-container');
            if (!recorderContainer) return;

            let content = '';
            if (state === 'idle') {
                content = `<button class="button" id="recordBtn">üé§ –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å</button>`;
            } else if (state === 'recording') {
                content = `<button class="button" id="stopBtn">‚èπÔ∏è –°—Ç–æ–ø</button>`;
            } else if (state === 'finished') {
                content = `<p>‚úîÔ∏è –ó–∞–ø–∏—Å—å –≥–æ—Ç–æ–≤–∞</p><button class="button" id="deleteBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>`;
            }
            recorderContainer.innerHTML = content;

            // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
            if (state === 'idle') document.getElementById('recordBtn').addEventListener('click', startRecording);
            if (state === 'recording') document.getElementById('stopBtn').addEventListener('click', stopRecording);
            if (state === 'finished') document.getElementById('deleteBtn').addEventListener('click', deleteRecording);
        }
        
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                audioBlob = null;
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    updateRecorderUI('finished');
                };
                updateRecorderUI('recording');
            }).catch(err => alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message));
        }

        function stopRecording() { if (mediaRecorder) mediaRecorder.stop(); }
        function deleteRecording() { audioBlob = null; audioChunks = []; updateRecorderUI('idle'); }

        // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ ---
        function sendReflectionData() {
            if (!audioBlob) {
                alert('–í—ã –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏ –≥–æ–ª–æ—Å.');
                return;
            }
            renderLoading();
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Audio = reader.result.split(',')[1];
                sendAction('process_reflection', { audio: base64Audio });
            };
            reader.readAsDataURL(audioBlob);
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                renderMainMenu();
            } catch (e) {
                console.error("Telegram WebApp script not found, running in browser mode.");
                renderMainMenu();
            }
        });
    </script>
</body>
</html>
